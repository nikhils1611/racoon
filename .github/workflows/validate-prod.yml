name: Deploy to Sandbox

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Salesforce CLI
      run: |
        npm install --global @salesforce/cli
        sf --version

    - name: Authenticate to Salesforce
      run: |
        echo "${{ secrets.SF_AUTH_URL }}" | sf org login sfdx-url --sfdx-url-stdin --set-default --alias sandbox
      env:
        SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}

    - name: Validate Metadata Exists
      run: |
        if [ ! -d "force-app" ] || [ -z "$(ls -A force-app)" ]; then
          echo "Error: force-app directory is empty or missing"
          exit 1
        fi

    - name: Deploy to Sandbox
      run: |
        sf project deploy start --source-dir force-app --wait 10 --test-level RunLocalTests --target-org sandbox

    - name: Deployment Status
      if: always()
      run: |
        sf org display --target-org sandbox